<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>متابعة الدفع - صيانة المدفن</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- خطوط عربية -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Cairo:wght@400;700&family=Lateef:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --green:#127369;
      --sand:#f6e58d;
      --paper:#e1eedd;
      --ok:#16a085;
      --bad:#c0392b;
      --ink:#575756;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Cairo',sans-serif;
      background-color:var(--paper);
      background-image:url('https://www.toptal.com/designers/subtlepatterns/uploads/islamic.png');
      background-repeat:repeat;
      background-size:340px 340px;
      margin:0;
      padding-top:80px;
      text-align:center;
      min-height:100vh;
    }
    .header{
      background:linear-gradient(90deg,var(--green) 50%, var(--sand) 100%);
      color:#fff;text-align:center;font-size:2rem;font-weight:bold;letter-spacing:2px;
      padding:25px 10px 18px 10px;position:fixed;top:0;right:0;left:0;
      box-shadow:0 4px 20px rgba(41,128,185,0.15);z-index:99;user-select:none;transition:background .5s;
    }
    .svg-border,.svg-border-bottom{width:95%;max-width:700px;height:30px;display:block;margin:0 auto}
    .svg-border{margin-bottom:10px}
    .svg-border-bottom{margin-top:10px;transform:scaleY(-1)}
    .quran-ayah{
      font-family:'Amiri Quran',serif;font-size:1.55em;color:var(--green);
      margin:22px 0 10px 0;text-shadow:0 1px 10px #d5d8dc;letter-spacing:1px;
    }
    .box{
      background:rgba(255,255,255,.97);margin:40px auto 20px auto;padding:26px 18px 20px 18px;
      border-radius:18px;box-shadow:0 0 18px 3px rgba(52,152,219,.13);max-width:650px;animation:fadeIn 1.2s;
    }
    h1,h3{color:var(--green);margin-bottom:14px}
    .button{
      background:linear-gradient(to right,#6d0622,var(--ink));color:#fff;border:none;
      padding:12px 20px;border-radius:12px;cursor:pointer;margin-top:15px;font-weight:600;letter-spacing:1px;font-size:19px;
      box-shadow:0 2px 12px 0 rgba(52,152,219,.11);transition:background .3s, transform .2s;
    }
    .button:hover{background:linear-gradient(to left,var(--green),var(--sand));transform:scale(1.05)}
    .button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .muted{opacity:.75}
    table{
      width:100%;margin-top:16px;border-collapse:collapse;font-size:17px;
      box-shadow:0 2px 10px rgba(41,128,185,.06);border-radius:10px 10px 0 0;overflow:hidden;transition:box-shadow .4s;
      background:rgba(255,255,255,.96);
    }
    th,td{padding:11px;border:1px solid #dfe6e9;transition:background .3s;text-align:center}
    th{background-color:var(--paper);font-weight:700;font-size:17px}
    .current-month{background-color:var(--sand)!important;font-weight:bold;animation:highlight 1.4s}
    .status-paid{color:var(--ok);font-weight:bold}
    .status-unpaid{color:var(--bad);font-weight:bold}
    .history{ text-align:right;margin-top:26px}
    .tools{
      display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 12px 0;flex-wrap:wrap
    }
    .search{
      display:flex;gap:8px;align-items:center
    }
    .search input{
      padding:10px 12px;border:1px solid #dfe6e9;border-radius:12px;min-width:220px;font-size:15px;outline:none
    }
    .pill{
      background:#fff;border:1px dashed var(--green);color:var(--green);
      padding:6px 10px;border-radius:999px;font-size:14px
    }
    .footer-dua{
      font-size:1.40em;color:var(--green);margin:34px 0 0 0;background:var(--paper);
      padding:18px 0 16px 0;border-radius:18px 18px 0 0;box-shadow:0 -2px 12px 0 rgba(52,152,219,.09);width:100%;
      font-family:'Lateef','Amiri','Cairo',serif;line-height:1.8;letter-spacing:1px;
    }
    .note{font-size:.95rem;color:#636e72;margin-top:10px}
    @keyframes highlight{0%{background-color:#fff59e}100%{background-color:var(--sand)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:700px){
      .header{font-size:1.3rem;padding:18px 2px 12px 2px}
      .box{padding:12px 3vw 10px 3vw;max-width:99vw}
      table{font-size:15px}
      .svg-border,.svg-border-bottom{height:20px}
      .search input{min-width:160px}
    }
  </style>
</head>
<body>
  <div class="header">صيانات مدفن آل بنونه</div>

  <!-- زخرفة إسلامية أعلى -->
  <div class="svg-border">
    <svg viewBox="0 0 1440 60" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:30px;display:block;">
      <path fill="#127369" fill-opacity="0.18" d="M0,40 C360,80 1080,0 1440,40 L1440,60 L0,60 Z"></path>
    </svg>
  </div>

  <!-- آية قرآنية -->
  <div class="quran-ayah">﴿ وَقُل رَّبِّ ارْحَمْهُمَا كَمَا رَبَّيَانِي صَغِيرًا ﴾</div>

  <div class="box" id="mainBox">
    <p>أنت مسجل باسم: <strong id="currentUser"></strong></p>
    <h1 id="payerTitle"></h1>

    <!-- عداد/تنبيه -->
    <div id="countdownBox" class="pill" style="display:none;margin:0 auto 6px auto;"></div>

    <button id="payButton" class="button" style="display:none;" onclick="markPaid()">تم الدفع</button>
    <div id="paidHint" class="note" style="display:none;">✅ تم تسجيل دفع هذا الشهر بالفعل.</div>

    <h3 style="margin-top:22px">جدول الدفع القادم:</h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>الشهر</th>
          <th>اسم الدافع</th>
          <th>حالة الدفع</th>
        </tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>

    <div class="history">
      <h3>سجل الدفع</h3>
      <div class="tools">
        <div class="search">
          <input id="nameFilter" list="namesList" placeholder="ابحث بالاسم (مثال: أبناء عادل بنونه)" />
          <datalist id="namesList"></datalist>
          <button class="button" id="clearFilterBtn" title="مسح البحث">مسح البحث</button>
        </div>
        <div>
          <button class="button" id="exportBtn">تصدير إلى Excel</button>
        </div>
      </div>

      <table id="historyTable" aria-label="سجل الدفع">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>تاريخ الدفع</th>
            <th>وقت التسجيل</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3" class="muted">جاري التحميل…</td></tr>
        </tbody>
      </table>

  <!-- دعاء في الفوتر -->
  <div class="footer-dua">
    اللهم اغفر لموتانا وارحمهم، وعافهم واعف عنهم، وأكرم نزلهم وأوسع مدخلهم وإغسلهم بالماء والثلج والبرد<br>
    وألحقنا بهم في جنات النعيم يا أرحم الراحمين.
  </div>

  <!-- زخرفة إسلامية أسفل -->
  <div class="svg-border-bottom">
    <svg viewBox="0 0 1440 60" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:30px;display:block;transform:scaleY(-1);">
      <path fill="#127369" fill-opacity="0.18" d="M0,40 C360,80 1080,0 1440,40 L1440,60 L0,60 Z"></path>
    </svg>
  </div>

  <!-- Firebase -->
  <script type="module">
    /***********************
     * Firebase Imports
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /***********************
     * Firebase Config
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAFEG5oQGt5LoMaCpOakDlu8BVz7vKXAgo",
      authDomain: "bannona-ee8ff.firebaseapp.com",
      projectId: "bannona-ee8ff",
      storageBucket: "bannona-ee8ff.firebasestorage.app",
      messagingSenderId: "334387338389",
      appId: "1:334387338389:web:cc07f20521e0670d1ecf9c",
      measurementId: "G-GW6X74QF72"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /***********************
     * بيانات أساسية
     ***********************/
    const names = ["ابوالعزايم بنونه", "علي بنونه", "عادل بنونه", "عبد السلام بنونه", "محمود بنونه"]; // ترتيب الدور
    const startDate   = new Date("2025-07-01");
    const today       = new Date();
    const fixedToday  = new Date(today.getFullYear(), today.getMonth(), 15); // لتثبيت الدور على منتصف الشهر

    const monthsDiff  = (fixedToday.getFullYear() - startDate.getFullYear()) * 12 +
                        (fixedToday.getMonth() - startDate.getMonth());
    const currentPayer = names[monthsDiff % names.length];

    // التحقق من المستخدم الحالي
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) window.location.href = "index.html";

    // تعبئة واجهة المستخدم
    document.getElementById("payerTitle").innerText = "الدور هذا الشهر على أبناء: " + currentPayer;
    document.getElementById("currentUser").innerText = currentUser;

    // إظهار زر الدفع فقط لو المستخدم عليه الدور
    const payBtn = document.getElementById("payButton");
    if (normalize(currentUser) === normalize(currentPayer)) {
      payBtn.style.display = "inline-block";
    }

    // تعبئة قائمة الأسماء في البحث
    const namesList = document.getElementById("namesList");
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = "أبناء: " + n;
      namesList.appendChild(opt);
    });

    /***********************
     * دوال مساعدة
     ***********************/
    function normalize(str){
      return (str || "")
        .replace(/[\u200E\u200F\u202A-\u202E\u061C]/g, "")
        .trim()
        .replace(/أ|إ|آ/g,"ا")
        .replace(/ى/g,"ي")
        .replace(/ئ/g,"ي")
        .replace(/ؤ/g,"و")
        .replace(/\s+/g,"")
        .toLowerCase();
    }

    function fixArabicNumber(str){
      if(!str) return "";
      str = str.replace(/[\u200E\u200F\u202A-\u202E\u061C]/g,"");
      str = str.replace(/[^0-9٠-٩\-\/]/g,""); // أرقام + / و -
      return str.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
    }

    function sameMonthYear(d1,d2){
      return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth();
    }

    function parsePaymentDate(dateStr){
      // يقبل "YYYY-MM-DD" أو "dd/mm/yyyy"
      if(!dateStr) return null;
      if(dateStr.includes("-")){
        const [y,m,d] = dateStr.split("-").map(fixArabicNumber);
        return new Date(+y, +m-1, +d);
      } else {
        const [d,m,y] = dateStr.split("/").map(fixArabicNumber);
        return new Date(+y, +m-1, +d);
      }
    }

    /***********************
     * كلمة السر من Firestore
     ***********************/
    let adminPassword = "";
    async function fetchPassword(){
      try{
        const docRef = doc(db, "settings", "admin");
        const snap = await getDoc(docRef);
        if(snap.exists()){
          adminPassword = String(snap.data().password || "");
        }else{
          console.warn("لم يتم العثور على مستند الإعدادات (settings/admin).");
        }
      }catch(err){
        console.error("خطأ في جلب كلمة السر:", err);
      }
    }

    /***********************
     * الكاش المحلي للسجل
     ***********************/
    const CACHE_KEY = "paymentsCache_v1";
    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!Array.isArray(obj.data)) return null;
        return obj;
      }catch{ return null; }
    }
    function saveCache(data){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ updatedAt: new Date().toISOString(), data }));
      }catch(e){ console.warn("تعذر حفظ الكاش:", e); }
    }

    let paymentsHistory = []; // الذاكرة الحالية
    let latestMonthPaidByCurrent = false; // هل دفع بالفعل هذا الشهر؟

    /***********************
     * جلب السجل من Firestore
     ***********************/
    async function getPaymentsHistory(){
      const q = query(collection(db, "payments"), orderBy("timestamp","desc"));
      const snapshot = await getDocs(q);
      const arr = [];
      snapshot.forEach(doc => arr.push(doc.data()));
      paymentsHistory = arr;
      saveCache(arr);
    }

    /***********************
     * عرض جدول السجل (مع فلتر)
     ***********************/
    function renderHistoryTable(){
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";

      const filter = document.getElementById("nameFilter").value.trim();
      const normalizedFilter = normalize(filter.replace("أبناء:",""));

      let rows = paymentsHistory;

      if(filter){
        rows = rows.filter(e => normalize(e.name).includes(normalizedFilter));
      }

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="muted">لا توجد نتائج مطابقة.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(entry => {
        const tr = document.createElement("tr");
        const niceTime = new Date(entry.timestamp).toLocaleString("ar-EG", { hour12:false });
        tr.innerHTML = `
          <td>${entry.name}</td>
          <td>${entry.date}</td>
          <td class="muted">${niceTime}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /***********************
     * جدول الدور القادم
     ***********************/
    function generateSchedule(){
      const tableBody = document.getElementById("scheduleBody");
      tableBody.innerHTML = "";

      // تحقق من حالة الشهر الحالي للدافع الحالي
      latestMonthPaidByCurrent = false;

      // سنبحث عن دفع الشهر الحالي لمن عليه الدور
      const currentMonthDate = new Date(fixedToday.getFullYear(), fixedToday.getMonth(), 1);

      for(let i=0;i<5;i++){
        const futureDate = new Date(fixedToday.getFullYear(), fixedToday.getMonth() + i, 1);
        const monthsSinceStart = (futureDate.getFullYear() - startDate.getFullYear())*12 + (futureDate.getMonth() - startDate.getMonth());
        const payerName = names[monthsSinceStart % names.length];
        const monthName = futureDate.toLocaleDateString("ar-EG", { month:"long", year:"numeric" });

        let statusTd = "<td></td>";

        if(i === 0){
          let paidEntry = null;
          for(const entry of paymentsHistory){
            const paymentDate = parsePaymentDate(entry.date);
            if(!paymentDate) continue;
            if(normalize(entry.name) === normalize(payerName) && sameMonthYear(paymentDate, futureDate)){
              paidEntry = entry; break;
            }
          }
          if(paidEntry){
            statusTd = `<td class="status-paid">تم الدفع بتاريخ: ${paidEntry.date}</td>`;
            if(normalize(payerName) === normalize(currentUser)) latestMonthPaidByCurrent = true;
          }else{
            statusTd = `<td class="status-unpaid">لم يتم الدفع بعد</td>`;
          }
        }

        const row = document.createElement("tr");
        row.innerHTML = `<td>${monthName}</td><td>أبناء: ${payerName}</td>${statusTd}`;
        if(i===0) row.classList.add("current-month");
        tableBody.appendChild(row);
      }

      // تحديث زر الدفع والملاحظات
      const paidHint = document.getElementById("paidHint");
      if (normalize(currentUser) === normalize(currentPayer)) {
        if(latestMonthPaidByCurrent){
          payBtn.disabled = true;
          paidHint.style.display = "block";
        }else{
          payBtn.disabled = false;
          paidHint.style.display = "none";
        }
      }
    }

    /***********************
     * عداد الأيام والتنبيه
     ***********************/
    function showCountdownIfNeeded(){
      const box = document.getElementById("countdownBox");
      if (normalize(currentUser) !== normalize(currentPayer)) {
        box.style.display = "none"; return;
      }
      const now = new Date();
      const endOfMonth = new Date(now.getFullYear(), now.getMonth()+1, 0);
      const remainingDays = Math.max(0, Math.ceil((endOfMonth - now) / (1000*60*60*24)));

      box.style.display = "inline-block";
      box.style.borderColor = now.getDate()>20 ? "var(--bad)" : "var(--green)";
      box.style.color       = now.getDate()>20 ? "var(--bad)" : "var(--green)";
      box.textContent = (now.getDate() > 20)
        ? `⚠️ تأخر الدفع! تبقّى ${remainingDays} يوم على نهاية الشهر`
        : `🗓️ تبقّى ${remainingDays} يوم على نهاية الشهر`;
    }

    /***********************
     * تسجيل الدفع (يمنع التكرار)
     ***********************/
    async function markPaid(){
      // جلب كلمة السر إن لم تكن محمّلة
      if(!adminPassword){
        await fetchPassword();
      }
      const password = prompt("من فضلك أدخل كلمة السر لتأكيد الدفع:");
      if(password !== adminPassword){
        alert("❌ كلمة السر غير صحيحة. لم يتم تسجيل الدفع.");
        return;
      }

      // تحقق إذا كان الدفع مسجلاً لهذا الشهر بالفعل لنفس الاسم
      const currentMonthStart = new Date(fixedToday.getFullYear(), fixedToday.getMonth(), 1);
      for(const entry of paymentsHistory){
        const paymentDate = parsePaymentDate(entry.date);
        if(!paymentDate) continue;
        if (normalize(entry.name) === normalize(currentUser) && sameMonthYear(paymentDate, currentMonthStart)){
          alert("⚠️ تم تسجيل الدفع لهذا الشهر مسبقًا!");
          return;
        }
      }

      // إنشاء السجل بصيغة تاريخ موحدة
      const entry = {
        name: currentUser,
        date: new Date().toLocaleDateString("en-CA"), // YYYY-MM-DD
        timestamp: new Date().toISOString()
      };

      try{
        await addDoc(collection(db,"payments"), entry);
        alert("✅ تم تسجيل الدفع بنجاح");
        // تحديث محلي سريع
        paymentsHistory.unshift(entry);
        saveCache(paymentsHistory);
        renderHistoryTable();
        generateSchedule();
        showCountdownIfNeeded();
      }catch(e){
        console.error("Error adding document:", e);
        alert("حدث خطأ أثناء التسجيل");
      }
    }
    // جعل الدالة متاحة للزر
    window.markPaid = markPaid;

    /***********************
     * تحميل السجل: كاش ثم سحابة
     ***********************/
    async function init(){
      // تحميل كلمة السر مبكرًا
      fetchPassword().catch(()=>{});

      // 1) اعرض من الكاش لو موجود
      const cached = loadCache();
      if(cached && Array.isArray(cached.data)){
        paymentsHistory = cached.data;
        renderHistoryTable();
        generateSchedule();
      }

      // 2) ثم حدّث من السحابة
      try{
        await getPaymentsHistory();
        renderHistoryTable();
        generateSchedule();
      }catch(e){
        console.error("تعذر تحديث السجل من السحابة:", e);
        if(!cached){
          // لا كاش ولا سحابة
          const tbody = document.getElementById("historyBody");
          tbody.innerHTML = `<tr><td colspan="3" class="muted">تعذر تحميل السجل الآن.</td></tr>`;
        }
      }

      // عداد الأيام
      showCountdownIfNeeded();
    }

    // فلترة السجل
    document.getElementById("nameFilter").addEventListener("input", renderHistoryTable);
    document.getElementById("clearFilterBtn").addEventListener("click", ()=>{
      document.getElementById("nameFilter").value = "";
      renderHistoryTable();
    });

    // تصدير CSV (المعروض حاليًا بعد الفلترة)
    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const filter = document.getElementById("nameFilter").value.trim();
      const normalizedFilter = normalize(filter.replace("أبناء:",""));
      const rows = [["الاسم","تاريخ الدفع","الوقت الكامل"]];
      (paymentsHistory || []).forEach(entry=>{
        if(!filter || normalize(entry.name).includes(normalizedFilter)){
          rows.push([entry.name, entry.date, entry.timestamp]);
        }
      });
      const csvContent = "\uFEFF" + rows.map(r => r.join(",")).join("\n"); // BOM لحل العربية
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "سجل_الدفع.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // بدء التشغيل
    init();
  </script>
</body>
</html>


