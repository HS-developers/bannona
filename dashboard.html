<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙØ¹ - ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø¯ÙÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Cairo:wght@400;700&family=Lateef:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --green:#127369;
      --sand:#f6e58d;
      --paper:#e1eedd;
      --ok:#16a085;
      --bad:#c0392b;
      --ink:#575756;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Cairo',sans-serif;
      background-color:var(--paper);
      background-image:url('https://www.toptal.com/designers/subtlepatterns/uploads/islamic.png');
      background-repeat:repeat;
      background-size:340px 340px;
      margin:0;
      padding-top:80px;
      text-align:center;
      min-height:100vh;
    }
    .header{
      background:linear-gradient(90deg,var(--green) 50%, var(--sand) 100%);
      color:#fff;text-align:center;font-size:2rem;font-weight:bold;letter-spacing:2px;
      padding:25px 10px 18px 10px;position:fixed;top:0;right:0;left:0;
      box-shadow:0 4px 20px rgba(41,128,185,0.15);z-index:99;user-select:none;transition:background .5s;
    }
    .svg-border,.svg-border-bottom{width:95%;max-width:700px;height:30px;display:block;margin:0 auto}
    .svg-border{margin-bottom:10px}
    .svg-border-bottom{margin-top:10px;transform:scaleY(-1)}
    .quran-ayah{
      font-family:'Amiri Quran',serif;font-size:1.55em;color:var(--green);
      margin:22px 0 10px 0;text-shadow:0 1px 10px #d5d8dc;letter-spacing:1px;
    }
    .box{
      background:rgba(255,255,255,.97);margin:40px auto 20px auto;padding:26px 18px 20px 18px;
      border-radius:18px;box-shadow:0 0 18px 3px rgba(52,152,219,.13);max-width:650px;animation:fadeIn 1.2s;
    }
    h1,h3{color:var(--green);margin-bottom:14px}
    .button{
      background:linear-gradient(to right,#6d0622,var(--ink));color:#fff;border:none;
      padding:12px 20px;border-radius:12px;cursor:pointer;margin-top:15px;font-weight:600;letter-spacing:1px;font-size:19px;
      box-shadow:0 2px 12px 0 rgba(52,152,219,.11);transition:background .3s, transform .2s;
    }
    .button:hover{background:linear-gradient(to left,var(--green),var(--sand));transform:scale(1.05)}
    .button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .muted{opacity:.75}
    table{
      width:100%;margin-top:16px;border-collapse:collapse;font-size:17px;
      box-shadow:0 2px 10px rgba(41,128,185,.06);border-radius:10px 10px 0 0;overflow:hidden;transition:box-shadow .4s;
      background:rgba(255,255,255,.96);
    }
    th,td{padding:11px;border:1px solid #dfe6e9;transition:background .3s;text-align:center}
    th{background-color:var(--paper);font-weight:700;font-size:17px}
    .current-month{background-color:var(--sand)!important;font-weight:bold;animation:highlight 1.4s}
    .status-paid{color:var(--ok);font-weight:bold}
    .status-unpaid{color:var(--bad);font-weight:bold}
    .history{ text-align:right;margin-top:26px}
    .tools{
      display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 12px 0;flex-wrap:wrap
    }
    .search{
      display:flex;gap:8px;align-items:center
    }
    .search input{
      padding:10px 12px;border:1px solid #dfe6e9;border-radius:12px;min-width:220px;font-size:15px;outline:none
    }
    .pill{
      background:#fff;border:1px dashed var(--green);color:var(--green);
      padding:6px 10px;border-radius:999px;font-size:14px
    }
    .footer-dua{
      font-size:1.40em;color:var(--green);margin:34px 0 0 0;background:var(--paper);
      padding:18px 0 16px 0;border-radius:18px 18px 0 0;box-shadow:0 -2px 12px 0 rgba(52,152,219,.09);width:100%;
      font-family:'Lateef','Amiri','Cairo',serif;line-height:1.8;letter-spacing:1px;
    }
    .note{font-size:.95rem;color:#636e72;margin-top:10px}
    @keyframes highlight{0%{background-color:#fff59e}100%{background-color:var(--sand)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:700px){
      .header{font-size:1.3rem;padding:18px 2px 12px 2px}
      .box{padding:12px 3vw 10px 3vw;max-width:99vw}
      table{font-size:15px}
      .svg-border,.svg-border-bottom{height:20px}
      .search input{min-width:160px}
    }
  </style>
</head>
<body>
  <div class="header">ØµÙŠØ§Ù†Ø§Øª Ù…Ø¯ÙÙ† Ø¢Ù„ Ø¨Ù†ÙˆÙ†Ù‡</div>

  <!-- Ø²Ø®Ø±ÙØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø£Ø¹Ù„Ù‰ -->
  <div class="svg-border">
    <svg viewBox="0 0 1440 60" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:30px;display:block;">
      <path fill="#127369" fill-opacity="0.18" d="M0,40 C360,80 1080,0 1440,40 L1440,60 L0,60 Z"></path>
    </svg>
  </div>

  <!-- Ø¢ÙŠØ© Ù‚Ø±Ø¢Ù†ÙŠØ© -->
  <div class="quran-ayah">ï´¿ ÙˆÙÙ‚ÙÙ„ Ø±ÙÙ‘Ø¨ÙÙ‘ Ø§Ø±Ù’Ø­ÙÙ…Ù’Ù‡ÙÙ…ÙØ§ ÙƒÙÙ…ÙØ§ Ø±ÙØ¨ÙÙ‘ÙŠÙØ§Ù†ÙÙŠ ØµÙØºÙÙŠØ±Ù‹Ø§ ï´¾</div>

  <div class="box" id="mainBox">
    <p>Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ø³Ù…: <strong id="currentUser"></strong></p>
    <h1 id="payerTitle"></h1>

    <!-- Ø¹Ø¯Ø§Ø¯/ØªÙ†Ø¨ÙŠÙ‡ -->
    <div id="countdownBox" class="pill" style="display:none;margin:0 auto 6px auto;"></div>

    <button id="payButton" class="button" style="display:none;" onclick="markPaid()">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
    <div id="paidHint" class="note" style="display:none;">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙØ¹Ù„.</div>

    <h3 style="margin-top:22px">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…:</h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø´Ù‡Ø±</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¯Ø§ÙØ¹</th>
          <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
        </tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>

    <div class="history">
      <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹</h3>
      <div class="tools">
        <div class="search">
          <input id="nameFilter" list="namesList" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø£Ø¨Ù†Ø§Ø¡ Ø¹Ø§Ø¯Ù„ Ø¨Ù†ÙˆÙ†Ù‡)" />
          <datalist id="namesList"></datalist>
          <button class="button" id="clearFilterBtn" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
        <div>
          <button class="button" id="exportBtn">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
        </div>
      </div>

      <table id="historyTable" aria-label="Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
            <th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
        </tbody>
      </table>

  <!-- Ø¯Ø¹Ø§Ø¡ ÙÙŠ Ø§Ù„ÙÙˆØªØ± -->
  <div class="footer-dua">
    Ø§Ù„Ù„Ù‡Ù… Ø§ØºÙØ± Ù„Ù…ÙˆØªØ§Ù†Ø§ ÙˆØ§Ø±Ø­Ù…Ù‡Ù…ØŒ ÙˆØ¹Ø§ÙÙ‡Ù… ÙˆØ§Ø¹Ù Ø¹Ù†Ù‡Ù…ØŒ ÙˆØ£ÙƒØ±Ù… Ù†Ø²Ù„Ù‡Ù… ÙˆØ£ÙˆØ³Ø¹ Ù…Ø¯Ø®Ù„Ù‡Ù… ÙˆØ¥ØºØ³Ù„Ù‡Ù… Ø¨Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„Ø«Ù„Ø¬ ÙˆØ§Ù„Ø¨Ø±Ø¯<br>
    ÙˆØ£Ù„Ø­Ù‚Ù†Ø§ Ø¨Ù‡Ù… ÙÙŠ Ø¬Ù†Ø§Øª Ø§Ù„Ù†Ø¹ÙŠÙ… ÙŠØ§ Ø£Ø±Ø­Ù… Ø§Ù„Ø±Ø§Ø­Ù…ÙŠÙ†.
  </div>

  <!-- Ø²Ø®Ø±ÙØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø£Ø³ÙÙ„ -->
  <div class="svg-border-bottom">
    <svg viewBox="0 0 1440 60" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:30px;display:block;transform:scaleY(-1);">
      <path fill="#127369" fill-opacity="0.18" d="M0,40 C360,80 1080,0 1440,40 L1440,60 L0,60 Z"></path>
    </svg>
  </div>

  <!-- Firebase -->
  <script type="module">
    /***********************
     * Firebase Imports
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /***********************
     * Firebase Config
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAFEG5oQGt5LoMaCpOakDlu8BVz7vKXAgo",
      authDomain: "bannona-ee8ff.firebaseapp.com",
      projectId: "bannona-ee8ff",
      storageBucket: "bannona-ee8ff.firebasestorage.app",
      messagingSenderId: "334387338389",
      appId: "1:334387338389:web:cc07f20521e0670d1ecf9c",
      measurementId: "G-GW6X74QF72"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /***********************
     * Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
     ***********************/
    const names = ["Ø§Ø¨ÙˆØ§Ù„Ø¹Ø²Ø§ÙŠÙ… Ø¨Ù†ÙˆÙ†Ù‡", "Ø¹Ù„ÙŠ Ø¨Ù†ÙˆÙ†Ù‡", "Ø¹Ø§Ø¯Ù„ Ø¨Ù†ÙˆÙ†Ù‡", "Ø¹Ø¨Ø¯ Ø§Ù„Ø³Ù„Ø§Ù… Ø¨Ù†ÙˆÙ†Ù‡", "Ù…Ø­Ù…ÙˆØ¯ Ø¨Ù†ÙˆÙ†Ù‡"]; // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±
    const startDate   = new Date("2025-07-01");
    const today       = new Date();
    const fixedToday  = new Date(today.getFullYear(), today.getMonth(), 15); // Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ù‡Ø±

    const monthsDiff  = (fixedToday.getFullYear() - startDate.getFullYear()) * 12 +
                        (fixedToday.getMonth() - startDate.getMonth());
    const currentPayer = names[monthsDiff % names.length];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) window.location.href = "index.html";

    // ØªØ¹Ø¨Ø¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    document.getElementById("payerTitle").innerText = "Ø§Ù„Ø¯ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ø£Ø¨Ù†Ø§Ø¡: " + currentPayer;
    document.getElementById("currentUser").innerText = currentUser;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¯ÙˆØ±
    const payBtn = document.getElementById("payButton");
    if (normalize(currentUser) === normalize(currentPayer)) {
      payBtn.style.display = "inline-block";
    }

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
    const namesList = document.getElementById("namesList");
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = "Ø£Ø¨Ù†Ø§Ø¡: " + n;
      namesList.appendChild(opt);
    });

    /***********************
     * Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
     ***********************/
    function normalize(str){
      return (str || "")
        .replace(/[\u200E\u200F\u202A-\u202E\u061C]/g, "")
        .trim()
        .replace(/Ø£|Ø¥|Ø¢/g,"Ø§")
        .replace(/Ù‰/g,"ÙŠ")
        .replace(/Ø¦/g,"ÙŠ")
        .replace(/Ø¤/g,"Ùˆ")
        .replace(/\s+/g,"")
        .toLowerCase();
    }

    function fixArabicNumber(str){
      if(!str) return "";
      str = str.replace(/[\u200E\u200F\u202A-\u202E\u061C]/g,"");
      str = str.replace(/[^0-9Ù -Ù©\-\/]/g,""); // Ø£Ø±Ù‚Ø§Ù… + / Ùˆ -
      return str.replace(/[Ù -Ù©]/g, d => "0123456789"["Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)]);
    }

    function sameMonthYear(d1,d2){
      return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth();
    }

    function parsePaymentDate(dateStr){
      // ÙŠÙ‚Ø¨Ù„ "YYYY-MM-DD" Ø£Ùˆ "dd/mm/yyyy"
      if(!dateStr) return null;
      if(dateStr.includes("-")){
        const [y,m,d] = dateStr.split("-").map(fixArabicNumber);
        return new Date(+y, +m-1, +d);
      } else {
        const [d,m,y] = dateStr.split("/").map(fixArabicNumber);
        return new Date(+y, +m-1, +d);
      }
    }

    /***********************
     * ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ù† Firestore
     ***********************/
    let adminPassword = "";
    async function fetchPassword(){
      try{
        const docRef = doc(db, "settings", "admin");
        const snap = await getDoc(docRef);
        if(snap.exists()){
          adminPassword = String(snap.data().password || "");
        }else{
          console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (settings/admin).");
        }
      }catch(err){
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:", err);
      }
    }

    /***********************
     * Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø³Ø¬Ù„
     ***********************/
    const CACHE_KEY = "paymentsCache_v1";
    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!Array.isArray(obj.data)) return null;
        return obj;
      }catch{ return null; }
    }
    function saveCache(data){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ updatedAt: new Date().toISOString(), data }));
      }catch(e){ console.warn("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´:", e); }
    }

    let paymentsHistory = []; // Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let latestMonthPaidByCurrent = false; // Ù‡Ù„ Ø¯ÙØ¹ Ø¨Ø§Ù„ÙØ¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ

    /***********************
     * Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Firestore
     ***********************/
    async function getPaymentsHistory(){
      const q = query(collection(db, "payments"), orderBy("timestamp","desc"));
      const snapshot = await getDocs(q);
      const arr = [];
      snapshot.forEach(doc => arr.push(doc.data()));
      paymentsHistory = arr;
      saveCache(arr);
    }

    /***********************
     * Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø¹ ÙÙ„ØªØ±)
     ***********************/
    function renderHistoryTable(){
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";

      const filter = document.getElementById("nameFilter").value.trim();
      const normalizedFilter = normalize(filter.replace("Ø£Ø¨Ù†Ø§Ø¡:",""));

      let rows = paymentsHistory;

      if(filter){
        rows = rows.filter(e => normalize(e.name).includes(normalizedFilter));
      }

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(entry => {
        const tr = document.createElement("tr");
        const niceTime = new Date(entry.timestamp).toLocaleString("ar-EG", { hour12:false });
        tr.innerHTML = `
          <td>${entry.name}</td>
          <td>${entry.date}</td>
          <td class="muted">${niceTime}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /***********************
     * Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù‚Ø§Ø¯Ù…
     ***********************/
    function generateSchedule(){
      const tableBody = document.getElementById("scheduleBody");
      tableBody.innerHTML = "";

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø§ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      latestMonthPaidByCurrent = false;

      // Ø³Ù†Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙØ¹ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ù† Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¯ÙˆØ±
      const currentMonthDate = new Date(fixedToday.getFullYear(), fixedToday.getMonth(), 1);

      for(let i=0;i<5;i++){
        const futureDate = new Date(fixedToday.getFullYear(), fixedToday.getMonth() + i, 1);
        const monthsSinceStart = (futureDate.getFullYear() - startDate.getFullYear())*12 + (futureDate.getMonth() - startDate.getMonth());
        const payerName = names[monthsSinceStart % names.length];
        const monthName = futureDate.toLocaleDateString("ar-EG", { month:"long", year:"numeric" });

        let statusTd = "<td></td>";

        if(i === 0){
          let paidEntry = null;
          for(const entry of paymentsHistory){
            const paymentDate = parsePaymentDate(entry.date);
            if(!paymentDate) continue;
            if(normalize(entry.name) === normalize(payerName) && sameMonthYear(paymentDate, futureDate)){
              paidEntry = entry; break;
            }
          }
          if(paidEntry){
            statusTd = `<td class="status-paid">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨ØªØ§Ø±ÙŠØ®: ${paidEntry.date}</td>`;
            if(normalize(payerName) === normalize(currentUser)) latestMonthPaidByCurrent = true;
          }else{
            statusTd = `<td class="status-unpaid">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯</td>`;
          }
        }

        const row = document.createElement("tr");
        row.innerHTML = `<td>${monthName}</td><td>Ø£Ø¨Ù†Ø§Ø¡: ${payerName}</td>${statusTd}`;
        if(i===0) row.classList.add("current-month");
        tableBody.appendChild(row);
      }

      // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      const paidHint = document.getElementById("paidHint");
      if (normalize(currentUser) === normalize(currentPayer)) {
        if(latestMonthPaidByCurrent){
          payBtn.disabled = true;
          paidHint.style.display = "block";
        }else{
          payBtn.disabled = false;
          paidHint.style.display = "none";
        }
      }
    }

    /***********************
     * Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡
     ***********************/
    function showCountdownIfNeeded(){
      const box = document.getElementById("countdownBox");
      if (normalize(currentUser) !== normalize(currentPayer)) {
        box.style.display = "none"; return;
      }
      const now = new Date();
      const endOfMonth = new Date(now.getFullYear(), now.getMonth()+1, 0);
      const remainingDays = Math.max(0, Math.ceil((endOfMonth - now) / (1000*60*60*24)));

      box.style.display = "inline-block";
      box.style.borderColor = now.getDate()>20 ? "var(--bad)" : "var(--green)";
      box.style.color       = now.getDate()>20 ? "var(--bad)" : "var(--green)";
      box.textContent = (now.getDate() > 20)
        ? `âš ï¸ ØªØ£Ø®Ø± Ø§Ù„Ø¯ÙØ¹! ØªØ¨Ù‚Ù‘Ù‰ ${remainingDays} ÙŠÙˆÙ… Ø¹Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±`
        : `ğŸ—“ï¸ ØªØ¨Ù‚Ù‘Ù‰ ${remainingDays} ÙŠÙˆÙ… Ø¹Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±`;
    }

    /***********************
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ (ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
     ***********************/
    async function markPaid(){
      // Ø¬Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù‘Ù„Ø©
      if(!adminPassword){
        await fetchPassword();
      }
      const password = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹:");
      if(password !== adminPassword){
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹.");
        return;
      }

      // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙØ¹ Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
      const currentMonthStart = new Date(fixedToday.getFullYear(), fixedToday.getMonth(), 1);
      for(const entry of paymentsHistory){
        const paymentDate = parsePaymentDate(entry.date);
        if(!paymentDate) continue;
        if (normalize(entry.name) === normalize(currentUser) && sameMonthYear(paymentDate, currentMonthStart)){
          alert("âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø³Ø¨Ù‚Ù‹Ø§!");
          return;
        }
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ Ø¨ØµÙŠØºØ© ØªØ§Ø±ÙŠØ® Ù…ÙˆØ­Ø¯Ø©
      const entry = {
        name: currentUser,
        date: new Date().toLocaleDateString("en-CA"), // YYYY-MM-DD
        timestamp: new Date().toISOString()
      };

      try{
        await addDoc(collection(db,"payments"), entry);
        alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");
        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹
        paymentsHistory.unshift(entry);
        saveCache(paymentsHistory);
        renderHistoryTable();
        generateSchedule();
        showCountdownIfNeeded();
      }catch(e){
        console.error("Error adding document:", e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
      }
    }
    // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø²Ø±
    window.markPaid = markPaid;

    /***********************
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„: ÙƒØ§Ø´ Ø«Ù… Ø³Ø­Ø§Ø¨Ø©
     ***********************/
    async function init(){
      // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø¨ÙƒØ±Ù‹Ø§
      fetchPassword().catch(()=>{});

      // 1) Ø§Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
      const cached = loadCache();
      if(cached && Array.isArray(cached.data)){
        paymentsHistory = cached.data;
        renderHistoryTable();
        generateSchedule();
      }

      // 2) Ø«Ù… Ø­Ø¯Ù‘Ø« Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
      try{
        await getPaymentsHistory();
        renderHistoryTable();
        generateSchedule();
      }catch(e){
        console.error("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", e);
        if(!cached){
          // Ù„Ø§ ÙƒØ§Ø´ ÙˆÙ„Ø§ Ø³Ø­Ø§Ø¨Ø©
          const tbody = document.getElementById("historyBody");
          tbody.innerHTML = `<tr><td colspan="3" class="muted">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†.</td></tr>`;
        }
      }

      // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…
      showCountdownIfNeeded();
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„
    document.getElementById("nameFilter").addEventListener("input", renderHistoryTable);
    document.getElementById("clearFilterBtn").addEventListener("click", ()=>{
      document.getElementById("nameFilter").value = "";
      renderHistoryTable();
    });

    // ØªØµØ¯ÙŠØ± CSV (Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©)
    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const filter = document.getElementById("nameFilter").value.trim();
      const normalizedFilter = normalize(filter.replace("Ø£Ø¨Ù†Ø§Ø¡:",""));
      const rows = [["Ø§Ù„Ø§Ø³Ù…","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒØ§Ù…Ù„"]];
      (paymentsHistory || []).forEach(entry=>{
        if(!filter || normalize(entry.name).includes(normalizedFilter)){
          rows.push([entry.name, entry.date, entry.timestamp]);
        }
      });
      const csvContent = "\uFEFF" + rows.map(r => r.join(",")).join("\n"); // BOM Ù„Ø­Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "Ø³Ø¬Ù„_Ø§Ù„Ø¯ÙØ¹.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    init();
  </script>
</body>
</html>


